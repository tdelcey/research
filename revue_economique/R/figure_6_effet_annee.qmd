## Figure 6: effet de l'année sur la prévalence espérée 

Le code ci-dessous regroupe les prévalences espérées selon l'année par méta-thématiques. Nous utilisons une version personalisée de `stm::plot.estimateEffect` pour extraire les effets de l'année sur la prévalence espérée des thématiques. Ensuite, nous utilisons `ggplot2` pour visualiser ces effets. 

```{r}
#| label: figure_6_facets_list
#| echo: TRUE
#| warning: FALSE
#| message: FALSE

library(dplyr)
library(ggplot2)
library(glue)
library(stringr)
library(purrr)

# --- chargement des objets nécessaires
ee_date <- readRDS(here::here(clean_corpus_path, "ee_date.rds"))
top_terms_prob <- readRDS(here::here(clean_corpus_path, "top_terms_prob.rds"))

ee_date <- ee_date %>%
  left_join(top_terms_prob, by = "topic") %>%
  select(-label) %>%
  left_join(metatopics %>% select(topic, label, champ), by = "topic") %>%
  mutate(facet_lab = paste0(topic, ": ", label))

# Fonction qui renvoie un ggplot pour une métathématique
make_plot_metachamp <- function(champ_name){
  df <- ee_date %>% filter(champ == champ_name)
  if(nrow(df) == 0) return(NULL)

  ymin <- min(df$estimate, na.rm = TRUE)
  ymax <- max(df$estimate, na.rm = TRUE)

  gg <- ggplot(df, aes(x = covariate.value, y = estimate)) +
    geom_line(linewidth = 0.4, colour = "black") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(~ facet_lab, ncol = 3) +
    labs(
      x = "Année",
      y = "Prévalence espérée",
      title = glue("Effet de l'année — {champ_name}")
    ) +
    theme_article_custom(base_size = 13) +
    theme(
      # reduce font size of facet labels
      strip.text = element_text(size = 9),
      plot.title = element_text(hjust = 0),
      #strip.background = element_rect(fill = "white", colour = "black"),
    ) +
    coord_cartesian(ylim = c(ymin, ymax))

  # calcul hauteur auto
  n_panels <- df %>% distinct(topic) %>% nrow()
  ncol_facets <- 3L
  nrow_facets <- ceiling(n_panels / ncol_facets)
  height_mm <- nrow_facets * 40 + 20

  slug <- champ_name %>%
    stringi::stri_trans_general("Latin-ASCII") %>%
    str_replace_all("[^A-Za-z0-9]+", "_") %>%
    str_replace("^_|_$", "")

  ggsave(
    filename = here::here(figures_path, glue("figure_year_effect_{slug}.png")),
    plot = gg, dpi = 300,
    width =  180, height = height_mm, units = "mm"
  )

  return(gg)
}

# --- génère la liste
list_metatopics <- ee_date$champ %>% unique() %>% sort()

list_plots <- map(set_names(list_metatopics), make_plot_metachamp)

# --- sauvegarde pour l'annexe en ligne
saveRDS(list_plots, here::here(clean_corpus_path, "list_plots_year_effect.rds"))

```


### Analyse historique

```{r}
#| echo: TRUE
#| warning: FALSE
#| label: figure_6_year_effect_hpe


list_plots <- readRDS(here::here(clean_corpus_path, "list_plots_year_effect.rds"))

p <- list_plots[['Analyse historique']] 

print(p)
```
### Microéconomie

```{r}
#| echo: TRUE
#| warning: FALSE
#| label: figure_6_year_effect_micro

p <- list_plots[['Microéconomie']] 
print(p)
```

### Economie internationale 


```{r}
#| echo: TRUE
#| warning: FALSE
#| label: figure_6_year_effect_international

p <- list_plots[['Economie internationale']] 

print(p)
```

### Macroéconomie

```{r}
#| echo: TRUE
#| warning: FALSE
#| label: figure_6_year_effect_macro

p <- list_plots[['Macroéconomie']]

print(p)

```

### Expertise économique

```{r}
#| echo: TRUE
#| warning: FALSE
#| label: figure_6_year_effect_ee

p <- list_plots[['Expertise économique']]

print(p)

```



