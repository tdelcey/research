## Figure 9: effet du genre 

```{r}
#| echo: TRUE 
#| warning: FALSE
#| fig.cap: "Estimate effect of having a women in the author list on topic prevalence"
#| label: figure_9_gender_effect

estimate_effect <- readRDS(here::here(clean_corpus_path, "estimate_effect_Local.rds"))

summary <- summary(estimate_effect)

summary_tibble <- summary$tables %>%
  purrr::imap_dfr( ~ {
    tibble(
      topic = .y,
      # Extract topic number
      term = rownames(.x),
      # Covariate names
      estimate = .x[, 1],
      # Coefficients
      std_error = .x[, 2],
      # Standard errors
      t_value = .x[, 3],
      # Confidence interval lower bound
      p_value = .x[, 4]   # Confidence interval upper bound
    )
  })

has_female_significant <- summary_tibble %>% 
  filter(term == "has_female1") 
  
df_reg <- has_female_significant %>%
  left_join(top_terms_prob, by = "topic") %>%
  left_join(metatopics %>% select(topic, label)) %>% 
  mutate(
    topic_label = paste0(topic, ": ", label),
    effect_group = case_when(
      p_value > .10 ~ "Non significatif au seuil de 90 %",
      estimate > 0 ~ "Effet positif",
      TRUE ~ "Effet négatif"
    )
  ) %>%
  mutate(topic_label = reorder(topic_label, estimate))

# graphique pour un groupe donné
plot_reg_group <- function(data, group_title) {
  ggplot(data, aes(x = estimate, y = topic_label)) +
    geom_point(size = 2, colour = "black") +
    geom_errorbarh(aes(xmin = estimate - 1.64*std_error, 
                       xmax = estimate + 1.64*std_error),
                   height = 0.1, colour = "black") +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(
      x = "Effet estimé (± IC 90%)",
      y = NULL,
      title = group_title
    ) +
    theme_article_custom()
}

# Séparer les trois groupes
df_pos <- df_reg %>% filter(effect_group == "Effet positif")
df_neg <- df_reg %>% filter(effect_group == "Effet négatif")
df_ns  <- df_reg %>% filter(effect_group == "Non significatif au seuil de 90 %")

p_pos <- plot_reg_group(df_pos, "Effets positifs (au moins une femme)")
p_neg <- plot_reg_group(df_neg, "Effets négatifs (au moins une femme)")
p_ns  <- plot_reg_group(df_ns, "Non significatifs")

# Afficher
print(p_pos) 
print(p_neg)
print(p_ns)

```
