## Figure 11: Cohérence et exclusivité des thématiques 

```{r}
#| echo: TRUE 
#| warning: FALSE
#| message: FALSE
#| label: figure_11_coherence_exclusivity 

evaluation_result <- readRDS(here(private_data_path, "evaluation_result_FULL_TEXT.rds"))

# plotting general metrics and choose a preprocessing treshold 
k_metric_summary <- evaluation_result %>%
  select(K, preprocessing, semantic_coherence, exclusivity) %>%
  rename(frex = exclusivity) %>%
  gather(Metric, Value, -K, -preprocessing) %>%
  mutate(
    preprocessing = factor(preprocessing, levels = c("1","5","10","15","20","30")),
    Metric = recode(Metric, "semantic_coherence" = "Cohérence", "frex" = "FREX")
  )

# Points choisis (adapte si besoin)
selected_points <- k_metric_summary %>%
  filter((K == 30 & preprocessing %in% c("30","15") & Metric == "FREX") |
         (K == 40 & preprocessing %in% c("5")         & Metric == "Cohérence") |
         (K == 50 & preprocessing %in% c("30")        & Metric == "FREX")) %>%
  mutate(label_choice = paste0("K=", K, ", Filtre=", preprocessing))

# palette de formes pour distinguer les niveaux de prétraitement
shapes_vec <- c(16, 17, 15, 3, 4, 8)  # autant que tes 6 filtres

p <- ggplot(k_metric_summary,
            aes(K, Value, group = preprocessing,
                shape = preprocessing)) +
  # ligne commune (noire fine)
  geom_line(colour = "black", linewidth = 0.2) +
  # tous les points
  geom_point(colour = "black", size = 3) +
  # facettes cohérence / FREX
  facet_wrap(~ Metric, scales = "free_y") +
  scale_shape_manual(values = shapes_vec, name = "Filtre") +
  labs(x = "K (Nombre de thématiques)", y = NULL) +
  theme_article_custom(base_size = 15) +
  theme(
    legend.position = "bottom",
    legend.key = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    strip.text = element_text(color = "black")
  ) +
  # points sélectionnés = cercles blancs
  geom_point(data = selected_points,
             aes(K, Value),
             inherit.aes = FALSE,
             shape = 21, fill = "white", colour = "black",
             size = 5, stroke = 1.1) +
  geom_text_repel(data = selected_points,
                  aes(K, Value, label = label_choice),
                  inherit.aes = FALSE,
                  size = 3.1, colour = "black",
                  segment.color = "grey40", max.overlaps = 20)

print(p)
```